name: SBOM upload for Monorepo Projects

on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - develop
  schedule:
    - cron: '0 0 * * 0'  # Runs every Sunday at midnight UTC

jobs:
  SBOM-upload:

    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write

    steps:
    # Step 1: Checkout the repository
    - uses: actions/checkout@v4

    # Step 2: Define project directories manually
    - name: Generate SBOM for Portal
      run: |
        curl -Lo $RUNNER_TEMP/sbom-tool https://github.com/microsoft/sbom-tool/releases/latest/download/sbom-tool-linux-x64
        chmod +x $RUNNER_TEMP/sbom-tool
        mkdir -p ./Portal/_sbom_output
        $RUNNER_TEMP/sbom-tool generate -b ./Portal -bc ./Portal/_sbom_output -pn "Portal" -pv "1.0.0" -ps "OwnerName" -nsb "https://sbom.mycompany.com" -V Verbose

    - name: Generate SBOM for ResourceProvisioner
      run: |
        curl -Lo $RUNNER_TEMP/sbom-tool https://github.com/microsoft/sbom-tool/releases/latest/download/sbom-tool-linux-x64
        chmod +x $RUNNER_TEMP/sbom-tool
        mkdir -p ./ResourceProvisioner/_sbom_output
        $RUNNER_TEMP/sbom-tool generate -b ./ResourceProvisioner -bc ./ResourceProvisioner/_sbom_output -pn "ResourceProvisioner" -pv "1.0.0" -ps "OwnerName" -nsb "https://sbom.mycompany.com" -V Verbose

    - name: Generate SBOM for ServerlessOperations
      run: |
        curl -Lo $RUNNER_TEMP/sbom-tool https://github.com/microsoft/sbom-tool/releases/latest/download/sbom-tool-linux-x64
        chmod +x $RUNNER_TEMP/sbom-tool
        mkdir -p ./ServerlessOperations/_sbom_output
        $RUNNER_TEMP/sbom-tool generate -b ./ServerlessOperations -bc ./ServerlessOperations/_sbom_output -pn "ServerlessOperations" -pv "1.0.0" -ps "OwnerName" -nsb "https://sbom.mycompany.com" -V Verbose

    # Step 3: Upload SBOMs for each project
    - name: Upload SBOMs
      uses: actions/upload-artifact@v4
      with:
        name: monorepo-sboms
        path: |
          ./Portal/_sbom_output/sbom.json
          ./ResourceProvisioner/_sbom_output/sbom.json
          ./ServerlessOperations/_sbom_output/sbom.json

    # Step 4: Submit SBOM (optional)
    - name: SBOM upload
      uses: advanced-security/spdx-dependency-submission-action@v0.1.1
      with:
        filePath: |
          ./Portal/_sbom_output/sbom.json
          ./ResourceProvisioner/_sbom_output/sbom.json
          ./ServerlessOperations/_sbom_output/sbom.json